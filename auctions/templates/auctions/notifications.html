{% extends "auctions/layout.html" %}
{% load static %}

{% block title %}Notifications{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Your Notifications</h2>
            
            <div id="notification-list" class="mt-3">
                <!-- Notifications will be loaded here -->
            </div>
            
            <div id="no-notifications" class="alert alert-info" style="display: none;">
                <i class="fas fa-bell-slash"></i> No notifications yet.
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Notification Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="realTimeNotifications" checked>
                        <label class="form-check-label" for="realTimeNotifications">
                            Real-time notifications
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="soundNotifications">
                        <label class="form-check-label" for="soundNotifications">
                            Sound notifications
                        </label>
                    </div>
                    <button id="mark-all-read" class="btn btn-outline-primary btn-sm mt-3">
                        <i class="fas fa-check-double"></i> Mark all as read
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast Template -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell text-primary me-2"></i>
            <strong class="me-auto">New Notification</strong>
            <small class="text-muted">now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <!-- Toast message will be inserted here -->
        </div>
    </div>
</div>

<script>
class NotificationManager {
    constructor() {
        this.socket = null;
        this.isConnected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;
        
        this.initializeWebSocket();
        this.loadNotifications();
        this.bindEvents();
    }
    
    initializeWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        try {
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onopen = (event) => {
                console.log('WebSocket connected');
                this.isConnected = true;
                this.reconnectAttempts = 0;
                this.updateConnectionStatus(true);
            };
            
            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };
            
            this.socket.onclose = (event) => {
                console.log('WebSocket disconnected');
                this.isConnected = false;
                this.updateConnectionStatus(false);
                this.attemptReconnect();
            };
            
            this.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        } catch (error) {
            console.error('Failed to create WebSocket:', error);
        }
    }
    
    attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
            
            setTimeout(() => {
                this.initializeWebSocket();
            }, this.reconnectDelay * this.reconnectAttempts);
        }
    }
    
    handleWebSocketMessage(data) {
        switch (data.type) {
            case 'notification':
                this.addNotificationToList(data.notification);
                this.showToast(data.notification);
                this.playNotificationSound();
                break;
            case 'notifications_list':
                this.renderNotifications(data.notifications);
                break;
            case 'notification_read':
                this.markNotificationAsRead(data.notification_id);
                break;
        }
    }
    
    loadNotifications() {
        if (this.isConnected && this.socket) {
            this.socket.send(JSON.stringify({
                'type': 'get_notifications'
            }));
        }
    }
    
    renderNotifications(notifications) {
        const container = document.getElementById('notification-list');
        const noNotificationsDiv = document.getElementById('no-notifications');
        
        if (notifications.length === 0) {
            container.innerHTML = '';
            noNotificationsDiv.style.display = 'block';
            return;
        }
        
        noNotificationsDiv.style.display = 'none';
        container.innerHTML = notifications.map(notification => 
            this.createNotificationHTML(notification)
        ).join('');
    }
    
    createNotificationHTML(notification) {
        const isRead = notification.is_read;
        const readClass = isRead ? '' : 'border-start border-primary border-3';
        const bgClass = isRead ? 'bg-light' : 'bg-white';
        
        return `
            <div class="card mb-2 ${bgClass} ${readClass}" data-notification-id="${notification.id}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="mb-1 ${isRead ? 'text-muted' : 'text-dark'}">${notification.message}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${this.formatDate(notification.created_at)}
                            </small>
                        </div>
                        <div class="ms-2">
                            ${!isRead ? `
                                <button class="btn btn-sm btn-outline-primary mark-read-btn" 
                                        onclick="notificationManager.markAsRead(${notification.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : `
                                <i class="fas fa-check-circle text-success"></i>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    addNotificationToList(notification) {
        const container = document.getElementById('notification-list');
        const noNotificationsDiv = document.getElementById('no-notifications');
        
        noNotificationsDiv.style.display = 'none';
        
        const notificationHTML = this.createNotificationHTML(notification);
        container.insertAdjacentHTML('afterbegin', notificationHTML);
    }
    
    markAsRead(notificationId) {
        if (this.isConnected && this.socket) {
            this.socket.send(JSON.stringify({
                'type': 'mark_as_read',
                'notification_id': notificationId
            }));
        }
    }
    
    markNotificationAsRead(notificationId) {
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.classList.remove('border-start', 'border-primary', 'border-3', 'bg-white');
            notificationElement.classList.add('bg-light');
            
            const textElement = notificationElement.querySelector('p');
            if (textElement) {
                textElement.classList.remove('text-dark');
                textElement.classList.add('text-muted');
            }
            
            const buttonContainer = notificationElement.querySelector('.ms-2');
            if (buttonContainer) {
                buttonContainer.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
            }
        }
    }
    
    markAllAsRead() {
        if (this.isConnected && this.socket) {
            this.socket.send(JSON.stringify({
                'type': 'mark_all_as_read'
            }));
        }
    }
    
    showToast(notification) {
        if (!document.getElementById('realTimeNotifications').checked) return;
        
        const toast = document.getElementById('notification-toast');
        const toastBody = toast.querySelector('.toast-body');
        
        toastBody.textContent = notification.message;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    playNotificationSound() {
        if (document.getElementById('soundNotifications').checked) {
            // Create a simple notification sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }
    }
    
    updateConnectionStatus(connected) {
        // You can add a connection status indicator here
        console.log('Connection status:', connected ? 'Connected' : 'Disconnected');
    }
    
    formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString();
    }
    
    bindEvents() {
        document.getElementById('mark-all-read').addEventListener('click', () => {
            this.markAllAsRead();
        });
        
        // Reload notifications when the page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && this.isConnected) {
                this.loadNotifications();
            }
        });
    }
}

// Initialize notification manager when page loads
let notificationManager;
document.addEventListener('DOMContentLoaded', () => {
    notificationManager = new NotificationManager();
});
</script>

<style>
.toast-container {
    z-index: 1055;
}

.card.border-start {
    border-left-width: 4px !important;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.mark-read-btn {
    opacity: 0.7;
    transition: opacity 0.2s;
}

.mark-read-btn:hover {
    opacity: 1;
}
</style>
{% endblock %}